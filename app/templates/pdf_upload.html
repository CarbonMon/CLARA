{% extends 'base.html' %}

{% block title %}CLARA - PDF Upload{% endblock %}

{% block content %}
<div class="docs-markdown-page docs-markdown-content">
    <div class="flex w-full items-start">
        <div class="docs-markdown-page-inner">
            <div>
                <div class="title-container flex flex-col items-baseline justify-between lg:flex-row">
                    <div class="order-2 lg:order-1">
                        <h1 id="page-top" class="docs-markdown-page-title">PDF Upload</h1>
                        <div class="docs-markdown-page-subtitle">Upload and analyze clinical trial PDFs with AI</div>
                    </div>
                </div>

                <p>Upload PDF documents containing clinical trial information for comprehensive AI analysis. The system will extract key study parameters, methodologies, and results.</p>

                <form method="POST" action="{{ url_for('main.pdf_upload') }}" enctype="multipart/form-data" id="uploadForm">
                    {{ form.csrf_token }}

                    <div class="card">
                        <div class="card-header" style="background-color: var(--color-bg-secondary); border-color: var(--color-border);">
                            <h3>File Upload</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">{{ form.files.label }}</label>
                                <div class="custom-file-upload" id="file-dropzone">
                                    <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“„</div>
                                    <p style="margin: 0 0 8px 0; font-weight: 500;">Drag and drop files here or click to browse</p>
                                    <p style="margin: 0; font-size: 14px; color: var(--color-text-secondary);">Supported formats: PDF, PNG, JPG</p>
                                </div>
                                {{ form.files(id="file-input", style="display: none;", multiple="multiple") }}
                                <div id="file-list" style="margin-top: 16px;">
                                    <!-- Selected files will appear here -->
                                </div>
                                {% if form.files.errors %}
                                <div class="alert alert-error" style="margin-top: 16px;">
                                    {% for error in form.files.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header" style="background-color: var(--color-bg-secondary); border-color: var(--color-border);">
                            <h3>Analysis Options</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                                <div>
                                    <div style="margin-bottom: 16px;">
                                        <input type="checkbox" id="use_ocr" name="use_ocr" style="margin-right: 8px;">
                                        <label for="use_ocr" style="font-weight: 500;">Enable OCR Processing</label>
                                    </div>
                                    <p style="font-size: 14px; color: var(--color-text-secondary); margin: 0;">
                                        Enable for scanned documents or images where text cannot be directly extracted
                                    </p>
                                </div>

                                <div id="language-selector" style="display: none;">
                                    <label class="form-label">Document Language</label>
                                    <select name="language" class="form-control">
                                        <option value="eng">English</option>
                                        <option value="spa">Spanish</option>
                                        <option value="fra">French</option>
                                        <option value="deu">German</option>
                                        <option value="ita">Italian</option>
                                    </select>
                                    <p style="font-size: 14px; color: var(--color-text-secondary); margin: 8px 0 0 0;">
                                        Select the primary language of the document for OCR processing
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <div>
                            <h4>Analysis Information</h4>
                            <p>The AI will analyze the uploaded documents to extract information such as:</p>
                            <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                                <li>Study design and methodology</li>
                                <li>Patient population and demographics</li>
                                <li>Interventions and treatments</li>
                                <li>Primary and secondary outcomes</li>
                                <li>Statistical analyses and results</li>
                            </ul>
                            <p style="margin: 8px 0 0 0;">For best results, upload clearly formatted clinical trial documents.</p>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 32px;">
                        {{ form.submit(class="btn btn-solid", id="submit-btn", disabled="disabled", style="padding: 12px 24px; font-size: 16px;") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        const dropzone = $('#file-dropzone');
        const fileInput = $('#file-input');
        const fileList = $('#file-list');
        const submitBtn = $('#submit-btn');
        const ocrCheckbox = $('#use_ocr');
        const languageSelector = $('#language-selector');
        const uploadForm = $('#uploadForm');
        
        // Toggle language selector based on OCR checkbox
        ocrCheckbox.on('change', function() {
            if ($(this).is(':checked')) {
                languageSelector.slideDown(300);
            } else {
                languageSelector.slideUp(300);
            }
        });
        
        // Handle file dropzone click - open file dialog
        dropzone.on('click', function(e) {
            fileInput.click();
        });
        
        // Handle drag and drop events
        dropzone.on('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.addClass('dragover');
        });
        
        dropzone.on('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.removeClass('dragover');
        });
        
        dropzone.on('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.removeClass('dragover');
            
            if (e.originalEvent.dataTransfer && e.originalEvent.dataTransfer.files.length) {
                // Update the file input with dropped files
                fileInput[0].files = e.originalEvent.dataTransfer.files;
                updateFileList();
            }
        });
        
        // Handle file selection via file dialog
        fileInput.on('change', function(e) {
            updateFileList();
        });
        
        // Update file list display
        function updateFileList() {
            const files = fileInput[0].files;
            fileList.empty();
            
            if (files.length > 0) {
                // Enable submit button
                submitBtn.prop('disabled', false);
                
                // Create file list
                const listGroup = $('<div class="list-group"></div>');
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileSize = formatFileSize(file.size);
                    const fileType = file.type.split('/')[1].toUpperCase();
                    
                    const listItem = `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas ${file.type.includes('pdf') ? 'fa-file-pdf text-danger' : 'fa-file-image text-primary'} me-2"></i>
                                <span>${file.name}</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary me-2">${fileType}</span>
                                <span class="badge bg-info me-3">${fileSize}</span>
                                <button type="button" class="btn btn-sm btn-outline-danger remove-file" data-index="${i}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    listGroup.append(listItem);
                }
                
                fileList.append(listGroup);
                
                // Set up remove buttons
                $('.remove-file').on('click', function() {
                    const index = $(this).data('index');
                    removeFile(index);
                });
            } else {
                // Disable submit button if no files
                submitBtn.prop('disabled', true);
            }
        }
        
        // Remove a file from the list
        function removeFile(index) {
            // Create a new FileList (using DataTransfer as a container)
            const dt = new DataTransfer();
            const files = fileInput[0].files;
            
            // Add all files except the one to remove
            for (let i = 0; i < files.length; i++) {
                if (i !== index) {
                    dt.items.add(files[i]);
                }
            }
            
            // Update the file input
            fileInput[0].files = dt.files;
            
            // Update the display
            updateFileList();
        }
        
        // Format file size
        function formatFileSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let unitIndex = 0;
            
            while (bytes >= 1024 && unitIndex < units.length - 1) {
                bytes /= 1024;
                unitIndex++;
            }
            
            return `${bytes.toFixed(1)} ${units[unitIndex]}`;
        }
    });
</script>
{% endblock %}
